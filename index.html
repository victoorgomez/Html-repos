<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wrapped 2026 Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #05070a; --card: #12151c; --accent: #22d3ee; }
        body { background-color: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; letter-spacing: -0.02em; overflow-x: hidden; }
        .glass-card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 28px; }
        .input-style { background: #1a1f26; border: 1px solid #2d353f; border-radius: 18px; padding: 16px; color: white; outline: none; transition: 0.2s; }
        .input-style:focus { border-color: var(--accent); }
        .btn-main { background: linear-gradient(135deg, #22d3ee 0%, #a855f7 100%); border-radius: 20px; font-weight: 800; }
        
        .frequent-card { background: #161a21; border-radius: 32px; padding: 24px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.03); }
        .city-accent { position: absolute; left: 0; top: 15%; bottom: 15%; width: 5px; border-radius: 0 10px 10px 0; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .stat-box { background: linear-gradient(145deg, #1e222d, #12151c); border-radius: 26px; padding: 20px; border: 1px solid rgba(255,255,255,0.03); display: flex; flex-direction: column; justify-content: space-between; min-height: 110px; }
        .achievement-card { border-radius: 24px; padding: 20px; display: flex; align-items: center; gap: 16px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 12px; }
        .badge-locked { filter: grayscale(1); opacity: 0.15; }
        .toggle-active { background: #22d3ee !important; color: black !important; }

        .bar-container:hover .tooltip { opacity: 1; visibility: visible; }
        .tooltip { opacity: 0; visibility: hidden; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background: #fff; color: #000; padding: 6px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; white-space: nowrap; pointer-events: none; transition: 0.2s; z-index: 20; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }

        .bg-grad-1 { background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%); }
        .bg-grad-2 { background: linear-gradient(135deg, #000428 0%, #004e92 100%); }
        .bg-grad-3 { background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%); }
        .bg-grad-4 { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .bg-grad-5 { background: linear-gradient(135deg, #52ff00 0%, #219614 100%); }
        .bg-grad-6 { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    </style>
</head>
<body class="p-6 pb-44 max-w-lg mx-auto">

    <header class="text-center mt-6 mb-10">
        <h1 class="text-5xl font-extrabold tracking-tighter bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 via-white to-purple-500 italic">Transporte 2026</h1>
        <div id="streak-counter" class="text-[10px] font-bold uppercase tracking-[0.3em] mt-3 text-gray-400 italic">SYNCING...</div>
    </header>

    <main id="tab-registro" class="tab-content active">
        <div class="glass-card p-7 mb-8 shadow-2xl border-white/10">
            <div class="space-y-5">
                <select id="tipo" onchange="toggleAvionMode()" class="input-style w-full font-bold text-sm">
                    <option value="üöá Metro">üöá Metro</option>
                    <option value="üöå Bus">üöå Bus</option>
                    <option value="üöÜ Cercan√≠as">üöÜ Cercan√≠as</option>
                    <option value="‚úàÔ∏è Avi√≥n">‚úàÔ∏è Avi√≥n</option>
                    <option value="üöÑ Tren">üöÑ Tren</option>
                    <option value="üöã Tranv√≠a">üöã Tranv√≠a</option>
                    <option value="‚õ¥Ô∏è Ferry">‚õ¥Ô∏è Ferry</option>
                    <option value="üö† Funicular">üö† Funicular</option>
                    <option value="üö° Telef√©rico">üö° Telef√©rico</option>
                </select>

                <div class="flex gap-4">
                    <input type="text" id="ciudad" placeholder="CIUDAD" class="input-style w-1/2 uppercase font-bold text-xs">
                    <input type="text" id="linea" placeholder="L√çNEA" class="input-style w-1/2 uppercase font-bold text-xs">
                </div>

                <div id="avion-extra" class="hidden">
                    <input type="text" id="modelo-avion" placeholder="MODELO AVI√ìN (EJ: A320)" class="input-style w-full uppercase font-bold text-xs">
                </div>

                <div class="flex items-center justify-between px-1">
                    <span class="text-[10px] font-black text-gray-500 uppercase tracking-widest">No hay l√≠nea en este transporte?</span>
                    <button id="no-line-btn" onclick="toggleNoLine()" class="px-4 py-2 rounded-full bg-white/5 text-[9px] font-black uppercase transition-all">Pulsa aqu√≠</button>
                </div>

                <button onclick="guardarViaje(); hapticFeedback(60);" class="btn-main w-full py-5 text-black text-xs uppercase font-black tracking-widest shadow-xl shadow-cyan-500/20">Registrar</button>
            </div>
        </div>

        <div class="flex gap-3 mb-4 animate-in fade-in">
            <select id="filter-ciudad" onchange="actualizarUI()" class="bg-[#1a1f26] text-white text-[10px] font-black uppercase rounded-xl border border-white/5 p-3 w-1/2 outline-none focus:border-cyan-400 transition-all">
                <option value="ALL">üåç Todas</option>
            </select>
            <select id="filter-transporte" onchange="actualizarUI()" class="bg-[#1a1f26] text-white text-[10px] font-black uppercase rounded-xl border border-white/5 p-3 w-1/2 outline-none focus:border-cyan-400 transition-all">
                <option value="ALL">üöÄ Todos</option>
            </select>
        </div>

        <div id="frecuentes" class="space-y-4"></div>
    </main>

    <main id="tab-fame" class="tab-content">
        <h2 class="text-3xl font-black mb-8 italic uppercase text-purple-400">Hall of Fame</h2>
        <div id="achievements-list" class="space-y-4"></div>
    </main>

    <main id="tab-stats" class="tab-content">
        <h2 class="text-3xl font-black mb-8 italic uppercase text-cyan-400">Insights</h2>
        <div id="stats-grid" class="grid grid-cols-2 gap-3 mb-4"></div>
        <div id="top-stats-full" class="space-y-3 mb-8"></div>
        <h3 class="text-[10px] font-black uppercase tracking-widest text-gray-500 mb-4 ml-1">Actividad 24h</h3>
        <div id="hour-chart" class="glass-card p-6 flex items-end justify-between h-44 gap-1 mb-8 relative"></div>
        <div id="extra-stats-area"></div>
    </main>

    <main id="tab-config" class="tab-content">
        <h2 class="text-3xl font-black mb-8 italic uppercase">Data</h2>
        <div class="glass-card p-8 border-white/10 space-y-6">
            <button onclick="exportarCSV()" class="w-full bg-white text-black py-5 rounded-2xl text-[10px] font-black uppercase">Exportar .CSV</button>
            <label class="block w-full bg-white/5 border border-white/10 py-5 rounded-2xl text-[10px] font-black uppercase text-center cursor-pointer">
                Importar .CSV
                <input type="file" accept=".csv" class="hidden" onchange="importarCSV(event)">
            </label>
            <button onclick="borrarTodo()" class="w-full text-red-500/40 py-2 text-[8px] uppercase font-bold tracking-widest mt-4">Borrar todo</button>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 glass-card bg-black/80 backdrop-blur-2xl border-white/10 p-2 flex gap-1 z-50 shadow-2xl">
        <button onclick="switchTab('registro')" id="btn-tab-registro" class="flex-1 py-4 rounded-2xl text-[9px] font-black uppercase">Viajes</button>
        <button onclick="switchTab('fame')" id="btn-tab-fame" class="flex-1 py-4 rounded-2xl text-[9px] font-black uppercase">Logros</button>
        <button onclick="switchTab('stats')" id="btn-tab-stats" class="flex-1 py-4 rounded-2xl text-[9px] font-black uppercase">Estad√≠sticas</button>
        <button onclick="switchTab('config')" id="btn-tab-config" class="flex-1 py-4 rounded-2xl text-[9px] font-black uppercase">Datos</button>
    </nav>

    <script>
        let viajes = JSON.parse(localStorage.getItem('viajes2026')) || [];
        let noLineActive = false;

        function hapticFeedback(ms) { if (window.navigator?.vibrate) window.navigator.vibrate(ms); }

        function toggleAvionMode() {
            const isAvion = document.getElementById('tipo').value === '‚úàÔ∏è Avi√≥n';
            document.getElementById('avion-extra').classList.toggle('hidden', !isAvion);
            const lineaInput = document.getElementById('linea');
            const noLineBtn = document.getElementById('no-line-btn');
            if (isAvion) {
                lineaInput.placeholder = "DESTINO";
                noLineBtn.style.opacity = "0.3";
            } else {
                lineaInput.placeholder = "L√çNEA";
                noLineBtn.style.opacity = "1";
            }
        }

        function toggleNoLine() {
            noLineActive = !noLineActive;
            const input = document.getElementById('linea');
            input.value = noLineActive ? "SIN L√çNEA" : "";
            input.disabled = noLineActive;
            document.getElementById('no-line-btn').classList.toggle('toggle-active', noLineActive);
        }

        function save() { 
            localStorage.setItem('viajes2026', JSON.stringify(viajes)); 
            actualizarUI(); 
            actualizarStreak();
        }

        function switchTab(tab) {
            hapticFeedback(15);
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            ['registro', 'fame', 'stats', 'config'].forEach(t => {
                const btn = document.getElementById(`btn-tab-${t}`);
                btn.className = `flex-1 py-4 rounded-2xl text-[9px] font-black uppercase transition-all ${t===tab ? 'bg-white text-black shadow-lg':'text-white/30'}`;
            });
            if(tab === 'stats') generarStats();
            if(tab === 'fame') generarLogros();
        }

        function guardarViaje(c, l, t, m) {
            const tipo = t || document.getElementById('tipo').value;
            const ciudad = (c || document.getElementById('ciudad').value).toUpperCase().trim();
            const linea = (l || document.getElementById('linea').value).toUpperCase().trim();
            const modelo = m || (tipo === '‚úàÔ∏è Avi√≥n' ? document.getElementById('modelo-avion').value.toUpperCase().trim() : null);
            if(!ciudad || !linea) return;
            viajes.unshift({ id: Date.now(), tipo, ciudad, linea, modelo, fecha: new Date().toISOString() });
            save();
            if(!c) { 
                document.getElementById('ciudad').value = ""; 
                if(!noLineActive) document.getElementById('linea').value = ""; 
                document.getElementById('modelo-avion').value = ""; 
            }
        }

        function removeOne(c, l, t, m) {
            const i = viajes.findIndex(v => v.ciudad === c && v.linea === l && v.tipo === t && v.modelo === m);
            if (i > -1) { viajes.splice(i, 1); save(); }
        }

        // --- GESTI√ìN DE FILTROS ---
        function updateFilters(allGrupos) {
            const selC = document.getElementById('filter-ciudad');
            const selT = document.getElementById('filter-transporte');
            const valC = selC.value;
            const valT = selT.value;

            // Obtener √∫nicos
            const cities = [...new Set(allGrupos.map(g => g.ciudad))].sort();
            const types = [...new Set(allGrupos.map(g => g.tipo))].sort();

            selC.innerHTML = '<option value="ALL">üåç TODAS</option>' + cities.map(c => `<option value="${c}">${c}</option>`).join('');
            selT.innerHTML = '<option value="ALL">üöÄ TODOS</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');

            // Restaurar selecci√≥n si existe
            if(cities.includes(valC) || valC === 'ALL') selC.value = valC;
            if(types.includes(valT) || valT === 'ALL') selT.value = valT;
        }

        function actualizarUI() {
            const gruposMap = {};
            viajes.forEach(v => {
                const k = `${v.tipo}|${v.ciudad}|${v.linea}|${v.modelo || ''}`;
                if (!gruposMap[k]) gruposMap[k] = { ...v, count: 0 };
                gruposMap[k].count++;
            });
            const allGrupos = Object.values(gruposMap);
            
            // Actualizar Opciones de Filtros
            updateFilters(allGrupos);

            // Leer valores actuales de filtros
            const filterC = document.getElementById('filter-ciudad').value;
            const filterT = document.getElementById('filter-transporte').value;

            // Filtrar
            const filteredGrupos = allGrupos.filter(g => {
                return (filterC === 'ALL' || g.ciudad === filterC) && 
                       (filterT === 'ALL' || g.tipo === filterT);
            });

            document.getElementById('frecuentes').innerHTML = filteredGrupos.sort((a,b) => b.count - a.count).map(g => {
                const color = `hsl(${Math.abs(g.ciudad.split('').reduce((a,b)=>a+b.charCodeAt(0),0)) % 360}, 75%, 65%)`;
                
                const isNoLine = g.linea === 'N/A' || g.linea === 'SIN L√çNEA';
                const mainTitle = isNoLine ? g.ciudad : g.linea;
                const subTitle = isNoLine ? g.tipo : `${g.ciudad} ${g.modelo ? `‚Ä¢ ${g.modelo}` : ''}`;
                
                return `
                <div class="frequent-card">
                    <div class="city-accent" style="background: ${color}"></div>
                    <div class="flex-1 ml-4">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[11px] font-black px-2 py-0.5 rounded-lg text-black" style="background: ${color}">${g.count}X</span>
                            <span class="text-[9px] font-bold opacity-40 uppercase tracking-tighter">${isNoLine ? '' : g.tipo}</span>
                        </div>
                        <div class="text-3xl font-black italic tracking-tighter leading-none mb-1 uppercase text-white">${mainTitle}</div>
                        <div class="text-[10px] font-black tracking-widest opacity-60 uppercase" style="color:${color}">${subTitle}</div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="removeOne('${g.ciudad}','${g.linea}','${g.tipo}', ${g.modelo ? `'${g.modelo}'` : 'null'})" class="w-12 h-12 rounded-2xl bg-white/5 text-red-500 font-light text-2xl active:scale-90 transition-all">‚àí</button>
                        <button onclick="guardarViaje('${g.ciudad}','${g.linea}','${g.tipo}', ${g.modelo ? `'${g.modelo}'` : 'null'})" class="w-12 h-12 rounded-2xl text-black shadow-lg active:scale-90 transition-all" style="background:${color}">+</button>
                    </div>
                </div>`;
            }).join('') || '<p class="text-center py-20 opacity-20 font-black uppercase text-[10px]">Sin resultados</p>';
        }

        function generarLogros() {
            const total = viajes.length;
            const ciudades = [...new Set(viajes.map(v => v.ciudad))].length;
            const co2 = viajes.filter(v => v.tipo !== '‚úàÔ∏è Avi√≥n').length * 1.8;

            const logs = [
                { icon: 'üê£', title: 'Primer Paso', desc: 'Registra tu primer viaje.', check: total >= 1, grad: 'bg-grad-1' },
                { icon: 'üåç', title: 'N√≥mada', desc: 'Viaja en 3 ciudades distintas.', check: ciudades >= 3, grad: 'bg-grad-3' },
                { icon: 'üçÉ', title: 'Eco-Warrior', desc: 'Ahorra 50kg de CO2.', check: co2 >= 50, grad: 'bg-grad-6' },
                { icon: 'ü¶á', title: 'Vampiro', desc: 'Viaje nocturno (00h-05h).', check: viajes.some(v => new Date(v.fecha).getHours() < 5), grad: 'bg-grad-2' },
                { icon: '‚úàÔ∏è', title: 'Capit√°n', desc: 'Primer vuelo registrado.', check: viajes.some(v => v.tipo === '‚úàÔ∏è Avi√≥n'), grad: 'bg-grad-4' },
                { icon: 'üî•', title: 'Leyenda', desc: 'Alcanza los 100 viajes.', check: total >= 100, grad: 'bg-grad-5' }
            ];

            document.getElementById('achievements-list').innerHTML = logs.map(l => `
                <div class="achievement-card ${l.check ? l.grad : 'bg-[#161a21] badge-locked'}">
                    <div class="text-4xl drop-shadow-md">${l.icon}</div>
                    <div>
                        <p class="font-black uppercase text-[11px] tracking-wide ${l.check ? 'text-black' : 'text-white'}">${l.title}</p>
                        <p class="text-[9px] font-bold ${l.check ? 'text-black/70' : 'text-gray-500'} leading-tight mt-1">${l.desc}</p>
                    </div>
                </div>
            `).join('');
        }

        function generarStats() {
            const total = viajes.length;
            if(total === 0) {
                document.getElementById('stats-grid').innerHTML = '<p class="col-span-2 text-center py-10 opacity-30 text-xs font-black uppercase">Faltan datos</p>';
                return;
            }

            const countsC = {}; const countsL = {}; const countsT = {};
            viajes.forEach(v => {
                countsC[v.ciudad] = (countsC[v.ciudad] || 0) + 1;
                countsL[`${v.tipo} ${v.linea}`] = (countsL[`${v.tipo} ${v.linea}`] || 0) + 1;
                countsT[v.tipo] = (countsT[v.tipo] || 0) + 1;
            });

            const topC = Object.entries(countsC).sort((a,b)=>b[1]-a[1])[0];
            const topL = Object.entries(countsL).sort((a,b)=>b[1]-a[1])[0];
            const topT = Object.entries(countsT).sort((a,b)=>b[1]-a[1])[0];

            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-box border-l-4 border-cyan-400">
                    <div class="text-[9px] font-black uppercase text-gray-400 tracking-widest">Total Viajes</div>
                    <div class="text-4xl font-black text-white">${total}</div>
                </div>
                <div class="stat-box border-l-4 border-purple-500">
                    <div class="text-[9px] font-black uppercase text-gray-400 tracking-widest">Favorito</div>
                    <div class="text-2xl font-black text-white truncate">${topT[0].split(' ')[1] || topT[0]}</div>
                    <div class="text-[8px] font-bold text-gray-500 uppercase mt-1">${topT[1]} usos</div>
                </div>
                <div class="stat-box border-l-4 border-white/20">
                    <div class="text-[9px] font-black uppercase text-gray-400 tracking-widest">Ciudad Top</div>
                    <div class="text-2xl font-black text-white truncate uppercase">${topC[0]}</div>
                </div>
                <div class="stat-box border-l-4 border-green-400">
                    <div class="text-[9px] font-black uppercase text-gray-400 tracking-widest">L√≠nea Top</div>
                    <div class="text-2xl font-black text-white truncate uppercase">${topL[0].replace(topL[0].split(' ')[0], '')}</div>
                </div>
            `;

            const hours = new Array(24).fill(0);
            viajes.forEach(v => hours[new Date(v.fecha).getHours()]++);
            const max = Math.max(...hours) || 1;
            document.getElementById('hour-chart').innerHTML = hours.map((h, i) => `
                <div class="flex-1 h-full flex flex-col justify-end group relative bar-container">
                    <div class="tooltip">${i}:00 ‚Ä¢ ${h} viajes</div>
                    <div class="bg-cyan-400/20 group-hover:bg-cyan-400 rounded-full transition-all duration-300" style="height: ${(h/max)*100}%; min-height:4px"></div>
                </div>
            `).join('');

            const co2 = viajes.filter(v => v.tipo !== '‚úàÔ∏è Avi√≥n').length * 1.8;
            const vuelos = viajes.filter(v => v.tipo === '‚úàÔ∏è Avi√≥n');
            let avionHtml = '';
            if(vuelos.length > 0) {
                const modelos = {}; vuelos.forEach(v => { if(v.modelo) modelos[v.modelo] = (modelos[v.modelo] || 0) + 1 });
                const topM = Object.entries(modelos).sort((a,b)=>b[1]-a[1])[0];
                if(topM) avionHtml = `<div class="stat-box bg-cyan-400/5 border-l-4 border-cyan-400 mb-4"><p class="text-[9px] font-black uppercase text-cyan-400 tracking-widest">Avi√≥n Top</p><p class="text-2xl font-black italic mt-1 uppercase">${topM[0]}</p></div>`;
            }

            document.getElementById('extra-stats-area').innerHTML = avionHtml + `
                <div class="stat-box bg-green-400/5 border-l-4 border-green-400">
                    <p class="text-[9px] font-black uppercase text-green-400 tracking-widest">Impacto Ecol√≥gico</p>
                    <p class="text-3xl font-black mt-1">~${co2.toFixed(1)}kg de CO2 ahorrados</p>
                    <p class="text-[9px] opacity-60 font-bold uppercase mt-1">respecto a usar coche</p>
                </div>
            `;
        }

        function actualizarStreak() {
            const days = [...new Set(viajes.map(v => new Date(v.fecha).toDateString()))].length;
            document.getElementById('streak-counter').innerHTML = `<span class="text-cyan-400">‚òÖ</span> ${days} D√çAS ACTIVOS`;
        }

        function exportarCSV() {
            let csv = "Tipo,Ciudad,Linea,Modelo,Fecha\n" + viajes.map(v => `"${v.tipo}","${v.ciudad}","${v.linea}","${v.modelo || ''}","${v.fecha}"`).join("\n");
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = 'transit_2026.csv'; a.click();
        }

        function importarCSV(event) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const lines = e.target.result.split('\n').slice(1);
                viajes = [...viajes, ...lines.filter(l => l.trim()).map(l => {
                    const [t, c, ln, m, f] = l.split(',').map(s => s.replace(/"/g, '').trim());
                    return { id: Date.now()+Math.random(), tipo: t, ciudad: c, linea: ln, modelo: m || null, fecha: f };
                })];
                save();
            };
            reader.readAsText(event.target.files[0]);
        }

        function borrarTodo() { if(confirm("¬øBorrar todos los datos?")) { viajes = []; save(); } }

        actualizarUI(); actualizarStreak(); switchTab('registro');
    </script>
</body>
</html>
